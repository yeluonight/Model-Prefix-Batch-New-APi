<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
    <title>æ¨¡å‹å‰ç¼€ç”Ÿæˆå™¨</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            padding: 16px;
            color: #2c3e50;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            padding: 24px;
        }

        h1 {
            text-align: center;
            color: #34495e;
            margin-bottom: 24px;
            font-size: 24px;
            font-weight: 600;
        }

        .section {
            margin-bottom: 20px;
            padding: 16px;
            background: #f8f9fa;
            border-radius: 12px;
            border: 1px solid #e9ecef;
        }

        .section-title {
            font-size: 14px;
            font-weight: 600;
            color: #495057;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .section-title::before {
            content: '';
            width: 3px;
            height: 14px;
            background: #5c7cfa;
            border-radius: 2px;
        }

        label {
            display: block;
            font-weight: 500;
            margin-bottom: 6px;
            color: #495057;
            font-size: 13px;
        }

        input[type="text"],
        input[type="password"] {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.2s;
            background: white;
        }

        input[type="text"]:focus,
        input[type="password"]:focus {
            outline: none;
            border-color: #5c7cfa;
            box-shadow: 0 0 0 3px rgba(92, 124, 250, 0.1);
        }

        .input-row {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }

        .input-row > div {
            flex: 1;
        }

        .btn {
            padding: 10px 18px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            touch-action: manipulation;
        }

        .btn-primary {
            background: #5c7cfa;
            color: white;
        }

        .btn-primary:hover {
            background: #4c6ef5;
        }

        .btn-primary:active {
            transform: scale(0.97);
        }

        .btn-primary:disabled {
            background: #adb5bd;
            cursor: not-allowed;
        }

        .btn-success {
            background: #51cf66;
            color: white;
        }

        .btn-success:hover {
            background: #40c057;
        }

        .btn-success:active {
            transform: scale(0.97);
        }

        .btn-danger {
            background: #ff6b6b;
            color: white;
        }

        .btn-danger:hover {
            background: #fa5252;
        }

        .btn-danger:active {
            transform: scale(0.97);
        }

        .btn-small {
            padding: 6px 14px;
            font-size: 13px;
        }

        .status-box {
            margin-top: 10px;
            padding: 10px 12px;
            border-radius: 8px;
            font-size: 13px;
            line-height: 1.5;
        }

        .status-info {
            background: #e7f5ff;
            color: #1971c2;
            border: 1px solid #a5d8ff;
        }

        .status-success {
            background: #d3f9d8;
            color: #2b8a3e;
            border: 1px solid #8ce99a;
        }

        .status-error {
            background: #ffe3e3;
            color: #c92a2a;
            border: 1px solid #ffa8a8;
        }

        .status-loading {
            background: #fff3bf;
            color: #e67700;
            border: 1px solid #ffe066;
        }

        .model-list {
            margin-top: 10px;
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 10px;
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            align-content: flex-start;
            background: white;
        }

        .model-item {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 10px;
            background: #f1f3f5;
            border-radius: 6px;
            font-size: 13px;
            border: 1px solid #e9ecef;
        }

        .model-item span {
            word-break: break-all;
            line-height: 1.4;
        }

        .btn-delete {
            background: #ff6b6b;
            color: white;
            padding: 2px 8px;
            font-size: 12px;
            border-radius: 4px;
            border: none;
            cursor: pointer;
        }

        .btn-delete:active {
            background: #fa5252;
            transform: scale(0.95);
        }

        .output-section {
            margin-top: 20px;
        }

        .output-box {
            margin-bottom: 16px;
        }

        .output-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .output-header h3 {
            color: #495057;
            font-size: 14px;
            font-weight: 600;
        }

        .output-content {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 12px;
            min-height: 80px;
            max-height: 200px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            line-height: 1.6;
            word-break: break-all;
            white-space: pre-wrap;
        }

        .empty-hint {
            color: #adb5bd;
            font-style: italic;
            font-size: 13px;
        }

        .button-group {
            display: flex;
            gap: 10px;
            margin-top: 16px;
        }

        @media (max-width: 600px) {
            .container {
                padding: 16px;
            }

            h1 {
                font-size: 20px;
            }

            .input-row {
                flex-direction: column;
            }
        }

        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f3f5;
            border-radius: 8px;
        }

        ::-webkit-scrollbar-thumb {
            background: #adb5bd;
            border-radius: 8px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #868e96;
        }

        .loading-spinner {
            display: inline-block;
            width: 14px;
            height: 14px;
            border: 2px solid #e67700;
            border-top-color: transparent;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin-right: 8px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸš€ æ¨¡å‹å‰ç¼€ç”Ÿæˆå™¨</h1>

        <!-- API è·å–æ¨¡å‹åŒºåŸŸ -->
        <div class="section">
            <div class="section-title">API è·å–æ¨¡å‹</div>
            <div class="input-row">
                <div style="flex: 2;">
                    <label for="baseUrl">Base URL</label>
                    <input type="text" id="baseUrl" placeholder="ä¾‹å¦‚ï¼šhttps://api.openai.com æˆ– https://generativelanguage.googleapis.com">
                </div>
                <div style="flex: 2;">
                    <label for="apiKey">API Key</label>
                    <input type="password" id="apiKey" placeholder="è¾“å…¥æ‚¨çš„ API Key">
                </div>
                <div style="display: flex; align-items: flex-end;">
                    <button class="btn btn-primary" onclick="fetchModels()" id="fetchBtn">è·å–æ¨¡å‹</button>
                </div>
            </div>
            <div id="apiStatus"></div>
        </div>

        <!-- å‰ç¼€å¤„ç†åŒºåŸŸ -->
        <div class="section">
            <div class="section-title">å‰ç¼€å¤„ç†</div>
            <div style="margin-bottom: 10px;">
                <label for="prefix">å‰ç¼€</label>
                <input type="text" id="prefix" placeholder="è¯·è¾“å…¥å‰ç¼€ï¼Œä¾‹å¦‚ï¼šprefix-">
            </div>
            <div>
                <label>æ¨¡å‹åç§°</label>
                <div class="input-row">
                    <input type="text" id="modelInput" placeholder="è¾“å…¥æ¨¡å‹åç§°ï¼Œå¤šä¸ªç”¨é€—å·åˆ†éš”ï¼Œä¾‹å¦‚ï¼šgpt-4,claude-3" style="flex: 1;">
                    <button class="btn btn-success btn-small" onclick="addModel()">æ·»åŠ </button>
                </div>
                <div class="model-list" id="modelList"></div>
            </div>
            <div class="button-group">
                <button class="btn btn-danger btn-small" onclick="clearAll()">æ¸…ç©ºæ‰€æœ‰</button>
            </div>
        </div>

        <!-- è¾“å‡ºåŒºåŸŸ -->
        <div class="output-section">
            <div class="output-box">
                <div class="output-header">
                    <h3>ğŸ“‹ åŠ å‰ç¼€çš„æ¨¡å‹ååˆ—è¡¨</h3>
                    <button class="btn btn-success btn-small" onclick="copyModels()">å¤åˆ¶</button>
                </div>
                <div class="output-content" id="modelOutput">
                    <span class="empty-hint">æš‚æ— æ•°æ®</span>
                </div>
            </div>

            <div class="output-box">
                <div class="output-header">
                    <h3>ğŸ“ JSON æ ¼å¼</h3>
                    <button class="btn btn-success btn-small" onclick="copyJSON()">å¤åˆ¶</button>
                </div>
                <div class="output-content" id="jsonOutput">
                    <span class="empty-hint">æš‚æ— æ•°æ®</span>
                </div>
            </div>
        </div>
    </div>

    <script>
        let models = [];

        // é¡µé¢åŠ è½½æ—¶ä» localStorage æ¢å¤æ•°æ®
        window.addEventListener('DOMContentLoaded', () => {
            const savedPrefix = localStorage.getItem('prefix');
            const savedModels = localStorage.getItem('models');

            if (savedPrefix) {
                document.getElementById('prefix').value = savedPrefix;
            }

            if (savedModels) {
                models = JSON.parse(savedModels);
                updateDisplay();
            }
        });

        // ç›‘å¬å‰ç¼€è¾“å…¥å˜åŒ–
        document.getElementById('prefix').addEventListener('input', () => {
            const prefix = document.getElementById('prefix').value;
            localStorage.setItem('prefix', prefix);
            updateDisplay();
        });

        // æ”¯æŒå›è½¦æ·»åŠ æ¨¡å‹
        document.getElementById('modelInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                addModel();
            }
        });

        // æ™ºèƒ½å¤„ç† Base URL
        function normalizeBaseUrl(url) {
            url = url.trim();
            if (!url) return { url: '', type: 'unknown' };

            // ç¡®ä¿æœ‰åè®®
            if (!url.startsWith('http://') && !url.startsWith('https://')) {
                url = 'https://' + url;
            }

            // ç§»é™¤æœ«å°¾æ–œæ 
            url = url.replace(/\/+$/, '');

            // æ£€æµ‹ API ç±»å‹
            let type = 'openai'; // é»˜è®¤ OpenAI

            if (url.includes('/v1beta')) {
                type = 'gemini';
                // ç§»é™¤ /v1betaï¼Œç¨åä¼šæ·»åŠ å®Œæ•´è·¯å¾„
                url = url.replace(/\/v1beta.*$/, '');
            } else if (!url.endsWith('/v1')) {
                // å¦‚æœæ²¡æœ‰ /v1ï¼Œæ·»åŠ å®ƒï¼ˆOpenAI æ ‡å‡†ï¼‰
                url = url + '/v1';
            }

            return { url, type };
        }

        // æ˜¾ç¤ºçŠ¶æ€
        function showStatus(message, type = 'info') {
            const statusEl = document.getElementById('apiStatus');
            statusEl.className = `status-box status-${type}`;

            if (type === 'loading') {
                statusEl.innerHTML = `<span class="loading-spinner"></span>${message}`;
            } else {
                statusEl.innerHTML = message;
            }
        }

        // è·å–æ¨¡å‹ï¼ˆOpenAI æ ¼å¼ï¼‰
        async function fetchOpenAIModels(baseUrl, apiKey) {
            const response = await fetch(`${baseUrl}/models`, {
                method: 'GET',
                headers: {
                    'Authorization': `Bearer ${apiKey}`,
                    'Content-Type': 'application/json'
                }
            });

            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }

            const data = await response.json();

            if (!data.data || !Array.isArray(data.data)) {
                throw new Error('å“åº”æ ¼å¼ä¸æ­£ç¡®ï¼Œç¼ºå°‘ data æ•°ç»„');
            }

            return data.data.map(model => model.id);
        }

        // è·å–æ¨¡å‹ï¼ˆGemini æ ¼å¼ï¼‰
        async function fetchGeminiModels(baseUrl, apiKey) {
            const response = await fetch(`${baseUrl}/v1beta/models?key=${apiKey}`, {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json'
                }
            });

            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }

            const data = await response.json();

            if (!data.models || !Array.isArray(data.models)) {
                throw new Error('å“åº”æ ¼å¼ä¸æ­£ç¡®ï¼Œç¼ºå°‘ models æ•°ç»„');
            }

            // Gemini è¿”å›çš„æ¨¡å‹åæ ¼å¼ï¼šmodels/gemini-pro
            return data.models.map(model => {
                const name = model.name || '';
                return name.replace('models/', '');
            }).filter(name => name);
        }

        // ä¸»è·å–å‡½æ•°
        async function fetchModels() {
            const baseUrlInput = document.getElementById('baseUrl').value;
            const apiKey = document.getElementById('apiKey').value.trim();
            const fetchBtn = document.getElementById('fetchBtn');

            // éªŒè¯è¾“å…¥
            if (!baseUrlInput.trim()) {
                showStatus('âŒ è¯·è¾“å…¥ Base URL', 'error');
                return;
            }

            if (!apiKey) {
                showStatus('âŒ è¯·è¾“å…¥ API Key', 'error');
                return;
            }

            // è§£æ URL
            const { url: baseUrl, type } = normalizeBaseUrl(baseUrlInput);

            try {
                fetchBtn.disabled = true;
                showStatus('æ­£åœ¨è·å–æ¨¡å‹åˆ—è¡¨...', 'loading');

                let fetchedModels = [];

                if (type === 'gemini') {
                    // ç›´æ¥å°è¯• Gemini
                    showStatus('æ­£åœ¨ä½¿ç”¨ Gemini API è·å–æ¨¡å‹...', 'loading');
                    fetchedModels = await fetchGeminiModels(baseUrl, apiKey);
                } else {
                    // å…ˆå°è¯• OpenAIï¼Œå¤±è´¥åˆ™å°è¯• Gemini
                    try {
                        showStatus('æ­£åœ¨ä½¿ç”¨ OpenAI API è·å–æ¨¡å‹...', 'loading');
                        fetchedModels = await fetchOpenAIModels(baseUrl, apiKey);
                    } catch (openaiError) {
                        showStatus('OpenAI æ ¼å¼å¤±è´¥ï¼Œå°è¯• Gemini æ ¼å¼...', 'loading');
                        // ç§»é™¤ /v1 åç¼€ï¼Œå°è¯• Gemini
                        const geminiUrl = baseUrl.replace(/\/v1$/, '');
                        fetchedModels = await fetchGeminiModels(geminiUrl, apiKey);
                    }
                }

                if (fetchedModels.length === 0) {
                    showStatus('âš ï¸ æœªè·å–åˆ°ä»»ä½•æ¨¡å‹', 'error');
                    return;
                }

                // æ·»åŠ åˆ°æ¨¡å‹åˆ—è¡¨ï¼ˆå»é‡ï¼‰
                const newModels = fetchedModels.filter(model => !models.includes(model));
                models.push(...newModels);
                saveAndUpdate();

                showStatus(`âœ… æˆåŠŸè·å– ${fetchedModels.length} ä¸ªæ¨¡å‹ï¼Œæ–°å¢ ${newModels.length} ä¸ª`, 'success');

            } catch (error) {
                console.error('è·å–æ¨¡å‹å¤±è´¥:', error);

                let errorMsg = 'âŒ è·å–å¤±è´¥ï¼š';

                if (error.message.includes('Failed to fetch') || error.message.includes('NetworkError')) {
                    errorMsg += 'ç½‘ç»œé”™è¯¯ï¼Œå¯èƒ½æ˜¯ CORS è·¨åŸŸé™åˆ¶ã€‚å»ºè®®ï¼š\n';
                    errorMsg += '1. ç¡®è®¤ API åœ°å€æ­£ç¡®\n';
                    errorMsg += '2. ä½¿ç”¨æµè§ˆå™¨æ‰©å±•è§£é™¤ CORS é™åˆ¶ï¼ˆå¦‚ CORS Unblockï¼‰\n';
                    errorMsg += '3. æ£€æŸ¥ API Key æ˜¯å¦æœ‰æ•ˆ';
                } else if (error.message.includes('401')) {
                    errorMsg += 'API Key æ— æ•ˆæˆ–å·²è¿‡æœŸ';
                } else if (error.message.includes('403')) {
                    errorMsg += 'æ— æƒé™è®¿é—®è¯¥ API';
                } else if (error.message.includes('404')) {
                    errorMsg += 'API ç«¯ç‚¹ä¸å­˜åœ¨ï¼Œè¯·æ£€æŸ¥ Base URL';
                } else if (error.message.includes('429')) {
                    errorMsg += 'API è¯·æ±‚é¢‘ç‡è¶…é™ï¼Œè¯·ç¨åå†è¯•';
                } else {
                    errorMsg += error.message;
                }

                showStatus(errorMsg, 'error');
            } finally {
                fetchBtn.disabled = false;
            }
        }

        function addModel() {
            const input = document.getElementById('modelInput');
            const inputValue = input.value.trim();

            if (inputValue) {
                // æŒ‰é€—å·åˆ†å‰²ï¼Œå»é™¤ç©ºæ ¼ï¼Œè¿‡æ»¤ç©ºå­—ç¬¦ä¸²
                const newModels = inputValue
                    .split(',')
                    .map(name => name.trim())
                    .filter(name => name && !models.includes(name));

                if (newModels.length > 0) {
                    models.push(...newModels);
                    input.value = '';
                    saveAndUpdate();
                }
            }
        }

        function deleteModel(index) {
            models.splice(index, 1);
            saveAndUpdate();
        }

        function clearAll() {
            const hasPrefix = document.getElementById('prefix').value.trim() !== '';
            const hasModels = models.length > 0;
            const hasApiInputs = document.getElementById('baseUrl').value.trim() !== '' ||
                                  document.getElementById('apiKey').value.trim() !== '';

            if (!hasPrefix && !hasModels && !hasApiInputs) return;

            let message = 'ç¡®å®šè¦æ¸…ç©º';
            const items = [];
            if (hasApiInputs) items.push('API é…ç½®');
            if (hasPrefix) items.push('å‰ç¼€');
            if (hasModels) items.push(`æ‰€æœ‰ ${models.length} ä¸ªæ¨¡å‹`);
            message += items.join('ã€') + 'å—ï¼Ÿ';

            if (confirm(message)) {
                // æ¸…ç©º API è¾“å…¥
                document.getElementById('baseUrl').value = '';
                document.getElementById('apiKey').value = '';
                document.getElementById('apiStatus').innerHTML = '';

                // æ¸…ç©ºå‰ç¼€
                document.getElementById('prefix').value = '';
                localStorage.setItem('prefix', '');

                // æ¸…ç©ºæ¨¡å‹
                models = [];
                saveAndUpdate();
            }
        }

        function saveAndUpdate() {
            localStorage.setItem('models', JSON.stringify(models));
            updateDisplay();
        }

        function updateDisplay() {
            const prefix = document.getElementById('prefix').value;
            const modelListEl = document.getElementById('modelList');
            const modelOutputEl = document.getElementById('modelOutput');
            const jsonOutputEl = document.getElementById('jsonOutput');

            // æ›´æ–°æ¨¡å‹åˆ—è¡¨ï¼ˆæ ‡ç­¾å½¢å¼ï¼‰
            if (models.length === 0) {
                modelListEl.innerHTML = '<div class="empty-hint" style="width: 100%; text-align: center; padding: 20px 0;">æš‚æ— æ¨¡å‹ï¼Œè¯·æ·»åŠ </div>';
            } else {
                modelListEl.innerHTML = models.map((model, index) => `
                    <div class="model-item">
                        <span>${model}</span>
                        <button class="btn btn-delete" onclick="deleteModel(${index})">Ã—</button>
                    </div>
                `).join('');
            }

            // æ›´æ–°åŠ å‰ç¼€çš„æ¨¡å‹ååˆ—è¡¨
            if (models.length === 0) {
                modelOutputEl.innerHTML = '<span class="empty-hint">æš‚æ— æ•°æ®</span>';
            } else {
                const prefixedModels = models.map(model => prefix + model);
                modelOutputEl.textContent = prefixedModels.join(',');
            }

            // æ›´æ–° JSON è¾“å‡º
            if (models.length === 0) {
                jsonOutputEl.innerHTML = '<span class="empty-hint">æš‚æ— æ•°æ®</span>';
            } else {
                const jsonObj = {};
                models.forEach(model => {
                    jsonObj[prefix + model] = model;
                });
                jsonOutputEl.textContent = JSON.stringify(jsonObj, null, 2);
            }
        }

        async function copyToClipboard(text, button) {
            try {
                // ä¼˜å…ˆä½¿ç”¨ç°ä»£ Clipboard API
                if (navigator.clipboard && window.isSecureContext) {
                    await navigator.clipboard.writeText(text);
                } else {
                    // é™çº§æ–¹æ¡ˆ
                    const textarea = document.createElement('textarea');
                    textarea.value = text;
                    textarea.style.position = 'fixed';
                    textarea.style.left = '-999999px';
                    textarea.style.top = '-999999px';
                    document.body.appendChild(textarea);
                    textarea.focus();
                    textarea.select();

                    // iOS ç‰¹æ®Šå¤„ç†
                    if (navigator.userAgent.match(/ipad|iphone/i)) {
                        const range = document.createRange();
                        range.selectNodeContents(textarea);
                        const selection = window.getSelection();
                        selection.removeAllRanges();
                        selection.addRange(range);
                        textarea.setSelectionRange(0, 999999);
                    }

                    document.execCommand('copy');
                    document.body.removeChild(textarea);
                }

                // æŒ‰é’®åé¦ˆ
                const originalText = button.textContent;
                button.textContent = 'âœ“ å·²å¤åˆ¶';
                setTimeout(() => {
                    button.textContent = originalText;
                }, 1500);
            } catch (err) {
                alert('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶');
                console.error('å¤åˆ¶å¤±è´¥:', err);
            }
        }

        function copyModels() {
            const prefix = document.getElementById('prefix').value;
            const prefixedModels = models.map(model => prefix + model);
            const text = prefixedModels.join(',');

            if (text) {
                copyToClipboard(text, event.target);
            }
        }

        function copyJSON() {
            const prefix = document.getElementById('prefix').value;
            const jsonObj = {};
            models.forEach(model => {
                jsonObj[prefix + model] = model;
            });
            const text = JSON.stringify(jsonObj, null, 2);

            if (models.length > 0) {
                copyToClipboard(text, event.target);
            }
        }
    </script>
</body>
</html>